name: Increment Version

inputs:
  git-user-email:
    description: 'Git User Email'
    required: true
  git-user-name:
    description: 'Git User Name'
    required: true
  branch:
    description: 'Branch Name'
    required: true

runs:
  using: "composite"
  steps:
    - name: Configure Git
      run: |
        git config --global user.email "${{ inputs.git-user-email }}"
        git config --global user.name "${{ inputs.git-user-name }}"
      shell: bash
    - name: Increment Beta Version
      if: "contains(inputs.branch, 'develop')"
      run: |
        echo ${{ inputs.branch }}
        CURRENT_VERSION=$(node -pe "require('./package.json').version")
        BETA_REGEX="[0-9]+\.[0-9]+\.[0-9]+\-beta\.[0-9]+"
        if [[ ${CURRENT_VERSION} =~ ${BETA_REGEX} ]];
        then
          npm --no-git-tag-version version prerelease --preid=beta
        else
          npm --no-git-tag-version version preminor --preid=beta
        fi
        CURRENT_VERSION=$(node -pe "require('./package.json').version")
        git commit -a -m $"Build ${CURRENT_VERSION}"
        git push --set-upstream origin develop
      shell: bash
    - name: Increment Patch Version
      if: "contains(inputs.branch, 'release/')"
      run: |
        echo ${{ inputs.branch }}
        RELEASE_BRANCH_VERSION=$(node -pe "require('./package.json').version" | cut -d '.' -f 1,2)
        npm version patch
        git push --set-upstream origin release/${RELEASE_BRANCH_VERSION} --tags
      shell: bash
